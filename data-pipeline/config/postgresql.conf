# data-pipeline/config/postgresql.conf
# PostgreSQL configuration for Rice Market development environment
# These settings optimize for development/testing while simulating Cloud SQL behavior

# Connection Settings - Similar to Cloud SQL defaults
max_connections = 100                  # Cloud SQL default for smaller instances
superuser_reserved_connections = 3     # Reserve connections for admin access

# Memory Settings - Scaled for development
shared_buffers = 256MB                 # ~25% of RAM for development
effective_cache_size = 1GB             # Estimate of OS cache available
work_mem = 4MB                         # Memory per query operation
maintenance_work_mem = 64MB           # Memory for maintenance operations

# Write Ahead Logging (WAL) - Reliability settings
wal_level = replica                   # Required for read replicas
max_wal_size = 1GB                    # Maximum WAL size between checkpoints
min_wal_size = 80MB                   # Minimum WAL size retained
archive_mode = on                     # Enable for backup/recovery
archive_command = '/bin/true'         # Placeholder for development

# Replication Settings - For read replica simulation
max_wal_senders = 3                   # Maximum concurrent replication connections
wal_keep_segments = 64                # WAL segments kept for replication
hot_standby = on                      # Allow read-only queries on replicas

# Query Tuning - Development optimizations
random_page_cost = 1.1                # SSD-optimized (Cloud SQL uses SSDs)
effective_io_concurrency = 200        # For SSDs
default_statistics_target = 100       # More detailed statistics

# Logging - Comprehensive for development
logging_collector = on                 # Enable log collection
log_directory = 'pg_log'              # Log directory
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                 # Daily rotation
log_rotation_size = 100MB             # Also rotate on size

# What to log - Development verbosity
log_connections = on                  # Log all connections
log_disconnections = on               # Log all disconnections
log_duration = on                     # Log query duration
log_statement = 'all'                 # Log all statements in dev
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on                  # Log checkpoint activity
log_lock_waits = on                   # Log long lock waits
log_temp_files = 0                    # Log all temp file usage

# Performance monitoring
track_activities = on                  # Track running queries
track_counts = on                     # Track table/index usage
track_io_timing = on                  # Track I/O timing
track_functions = all                 # Track function usage
stats_temp_directory = '/tmp/pg_stat_tmp'

# Statement tracking - Essential for optimization
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# Autovacuum - Keep tables optimized
autovacuum = on                       # Enable autovacuum
autovacuum_max_workers = 4           # Parallel vacuum workers
autovacuum_naptime = 30s             # Check interval
autovacuum_vacuum_threshold = 50     # Min row updates before vacuum
autovacuum_analyze_threshold = 50    # Min row updates before analyze
autovacuum_vacuum_scale_factor = 0.1 # Fraction of table size
autovacuum_analyze_scale_factor = 0.05

# Lock Management
deadlock_timeout = 1s                 # Detect deadlocks quickly in dev
lock_timeout = 0                      # No lock timeout by default

# Client Connection Defaults
statement_timeout = 300000            # 5 minute timeout for queries
idle_in_transaction_session_timeout = 600000  # 10 min idle transaction timeout

# Development Helpers
enable_seqscan = on                   # Allow sequential scans
enable_indexscan = on                 # Allow index scans
enable_bitmapscan = on                # Allow bitmap scans
enable_hashjoin = on                  # Allow hash joins
enable_mergejoin = on                 # Allow merge joins
enable_material = on                  # Allow materialization

# Error Reporting - Verbose for development
log_min_messages = info               # Minimum message level to log
log_min_error_statement = error       # Log statements causing errors
log_min_duration_statement = 100      # Log queries slower than 100ms

# Locale Settings
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'
